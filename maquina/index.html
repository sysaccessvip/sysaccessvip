<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SIII</title>

    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        ::-webkit-scrollbar { display: none; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #sidebar { transition: transform 0.3s ease-in-out; }
        #full-player { transition: transform 0.3s ease-in-out; will-change: transform; }
        #mini-player { transition: transform 0.3s ease-in-out, opacity 0.3s; will-change: transform, opacity; }

        .page { display: none; }
        .page.active { display: block; }

        #player-video-container { width: 100%; max-width: 640px; margin: 0 auto; position: relative; background: #000; border-radius: .5rem; overflow: hidden; height: 0; padding-top: 56.25%; }
        #player-video-container iframe, #player-video-container > div { position: absolute !important; top: 0; left: 0; width: 100% !important; height: 100% !important; border: 0; display: block; }
        
        #player-video-container:fullscreen { padding-top: 0; height: 100%; width: 100%; max-width: 100%; border-radius: 0; }
        #player-video-container:-webkit-full-screen { padding-top: 0; height: 100%; width: 100%; max-width: 100%; border-radius: 0; }
        
        #player-iframe-wrapper { position: absolute; left: -9999px; top: -9999px; width: 1px; height: 1px; overflow: hidden; pointer-events: none; }

        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 60; }
        .modal { background: #0f1724; color: white; padding: 1rem; border-radius: .5rem; width: 360px; max-width: calc(100% - 32px); }
        .modal h3 { margin-bottom: .5rem; }

        .toast { position: fixed; right: 16px; bottom: 16px; background: rgba(17,24,39,0.95); color: white; padding: 10px 14px; border-radius: 8px; z-index: 70; box-shadow: 0 6px 18px rgba(2,6,23,0.6); }

        .marquee-container { overflow: hidden; white-space: nowrap; width: 100%; }
        .marquee-text { display: inline-block; padding-left: 100%; animation: marquee 10s linear infinite; }
        .marquee-text-mini { display: inline-block; padding-left: 100%; animation: marquee 8s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .item-delete-btn { padding: 4px; border-radius: 99px; background-color: rgba(75, 85, 99, 0.7); margin-left: auto; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .item-delete-btn:hover { background-color: rgba(239, 68, 68, 0.8); }
        .item-delete-btn svg { width: 1.25rem; height: 1.25rem; }
       
        #playlist-header { height: 300px; position: relative; background-size: cover; background-position: center; transition: height 0.3s ease-out; }
        #playlist-header::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(15, 23, 36, 1) 5%, rgba(15, 23, 36, 0.4) 50%, rgba(15, 23, 36, 0) 100%); }
        #playlist-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 1rem; z-index: 10; }
        #playlist-sticky-header { position: sticky; top: 0; z-index: 20; background-color: rgba(15, 23, 36, 0.8); backdrop-filter: blur(10px); padding: 1rem; display: flex; align-items: center; transition: opacity 0.3s ease-out, transform 0.3s ease-out; opacity: 0; transform: translateY(-100%); }
        #page-playlist-details.scrolled #playlist-sticky-header { opacity: 1; transform: translateY(0); }
        #page-playlist-details.scrolled #playlist-header { height: 100px; }

        /* === ESTILOS MEJORADOS PARA BARRA DE PROGRESO === */
        #player-progress-bar {
            --progress-percent: 0%;
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
            height: 16px; /* Aumenta el √°rea de toque */
        }
        #player-progress-bar::-webkit-slider-runnable-track {
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(to right, #fff var(--progress-percent), rgba(255, 255, 255, 0.3) var(--progress-percent));
            transition: background 0.2s linear;
        }
        #player-progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            margin-top: -6px;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }
        #player-progress-bar:focus { outline: none; }
        
        #player-queue-panel { position: absolute; bottom: 0; left: 0; right: 0; height: 65%; background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(10px); border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            /* ==== INICIO DE CAMBIO (CSS) ==== */
            z-index: 20; /* Aumentamos z-index para que est√© sobre el contenido (z-10) */
            /* ==== FIN DE CAMBIO (CSS) ==== */
            display: flex; flex-direction: column; 
        }
        #player-queue-panel.visible { transform: translateY(0); }
        #player-queue-handle { padding: 0.5rem; text-align: center; cursor: s-resize; flex-shrink: 0; touch-action: none; } /* touch-action: none es clave para el gesto */

        /* Auth overlay minimal styles */
        #auth-overlay { transition: opacity 220ms ease; }
        #auth-overlay.hidden { opacity:0; pointer-events:none; }



/* === Mini visualizer (ecualizador) + pause animation === */
#mini-play-pause-btn { position: relative; overflow: visible; display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; transition: background-color 220ms ease, transform 220ms ease; }

/* contenedor del eq (3 barras) */
.mini-eq { display:flex; align-items:end; gap:4px; width:24px; height:18px; pointer-events:none; }
.mini-eq .bar { width:4px; background: currentColor; border-radius:2px; transform-origin: bottom; display:block; height:6px; transition: height 220ms cubic-bezier(.2,.9,.2,1), opacity 220ms; }

/* animaci√≥n de onda - cada barra con delay distinto */
@keyframes eqWave {
  0% { transform: scaleY(0.35); }
  25% { transform: scaleY(1.0); }
  50% { transform: scaleY(0.55); }
  75% { transform: scaleY(0.9); }
  100% { transform: scaleY(0.35); }
}

/* cuando est√° en reproducci√≥n, animar */
#mini-play-pause-btn.mini-playing .mini-eq .bar {
  animation: eqWave 900ms ease-in-out infinite;
}
#mini-play-pause-btn.mini-playing .mini-eq .b1 { animation-delay: 0ms; }
#mini-play-pause-btn.mini-playing .mini-eq .b2 { animation-delay: 120ms; }
#mini-play-pause-btn.mini-playing .mini-eq .b3 { animation-delay: 240ms; }

/* cuando est√° pausado, barras quietas y peque√±as */
#mini-play-pause-btn.mini-paused .mini-eq .bar { animation: none; height:6px; opacity:1; transform: none; }

/* Est√©tica de las barras seg√∫n el estado (uso currentColor, el bot√≥n controla color) */
#mini-play-pause-btn { color: #fff; } /* por defecto blanco; fondo controlado por classes mini-playing / mini-paused */

/* Pausa: contenedor con 2 barras verticales animadas */
.mini-pause-anim { position:absolute; display:flex; gap:6px; align-items:center; justify-content:center; pointer-events:none; width:16px; height:22px; opacity:0; transform: scale(.8); transition: opacity 220ms ease, transform 220ms ease; }
.mini-pause-anim span { display:block; width:4px; height:16px; border-radius:2px; background: currentColor; transform-origin:center; }

/* Cuando el estado es 'paused' mostramos la animaci√≥n de pause con entrada */
#mini-play-pause-btn.mini-paused .mini-pause-anim { opacity:1; transform: scale(1); }

/* Cuando est√° reproduciendo ocultamos la pausa */
#mini-play-pause-btn.mini-playing .mini-pause-anim { opacity:0; transform: scale(.85); }

/* iconos SVG fallback: los ocultamos cuando usamos visualizadores, pero mantenemos por accesibilidad */
#mini-play-icon, #mini-pause-icon { position: absolute; width:18px; height:18px; pointer-events:none; transition: opacity 160ms ease, transform 160ms ease; }
#mini-play-icon.hidden, #mini-pause-icon.hidden { opacity:0; transform: scale(.9); pointer-events:none; }
#mini-play-icon, #mini-pause-icon { opacity:0; }

/* Cuando pausado mostramos ligeramente el icono play (opcional) */
#mini-play-pause-btn.mini-paused #mini-play-icon { opacity:0; } /* lo mantenemos oculto: usamos la pausa anim y barras */
#mini-play-pause-btn.mini-playing #mini-pause-icon { opacity:0; }

/* Bot√≥n colores de fondo (mantener tu convenci√≥n) */
#mini-play-pause-btn.mini-paused { background-color: #1c1b1b !important; color: #fff !important; }
#mini-play-pause-btn.mini-playing { background-color: #1c1b1b !important; color: #fff !important; box-shadow: 0 6px 18px rgba(239,68,68,0.14); }

/* pulso peque√±o al cambiar estado */
@keyframes miniPulse2 {
  0% { transform: scale(1); }
  50% { transform: scale(1.08); }
  100% { transform: scale(1); }
}
#mini-play-pause-btn.pulse-anim { animation: miniPulse2 360ms cubic-bezier(.2,.9,.2,1); }



.bg-gray-700 {
    background-color: rgba(42, 53, 78, 0.6) !important; /* color con transparencia */
    backdrop-filter: blur(12px); /* aplica el efecto borroso */
    -webkit-backdrop-filter: blur(12px); /* soporte para Safari */
    border: 1px solid rgba(255, 255, 255, 0.1); /* opcional: borde suave tipo vidrio */
    border-radius: 8px; /* opcional: esquinas redondeadas */
}

.bg-gray-800 {
    background-color: rgba(17, 29, 50, 0.6) !important; /* color con transparencia */
    backdrop-filter: blur(12px) saturate(180%); /* desenfoque y realce */
    -webkit-backdrop-filter: blur(12px) saturate(180%); /* compatibilidad Safari */
    border: 1px solid rgba(255, 255, 255, 0.1); /* sutil borde tipo vidrio */
    border-radius: 12px; /* opcional, para bordes suaves */
}


.bg-blue-600 {
    --tw-bg-opacity: 1!important; 
    color: #2a354e!important; 
}

.text-gray-400 {
    --tw-text-opacity: 1!important; 
    color: rgb(255 255 255)!important; 
}


.bg-green-600 {
    --tw-bg-opacity: 1 !important;
    background-color: rgb(42 53 78) !important;
}


.bg-blue-600 {
    --tw-bg-opacity: 1!important;
    background-color: rgb(212 177 145)!important;
}

.text-blue-500 {
    --tw-text-opacity: 1 !important;
    color: #d4b191 !important;
}

/* === LOGIN MUSICAL ‚Äî estilos nuevos === */
#auth-overlay {
  position: fixed;
  inset: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 320ms ease, transform 320ms ease;
  opacity: 1;
  pointer-events: auto;
}

#auth-overlay.hidden { opacity: 0; pointer-events: none; }

#auth-bg-image {
  position: absolute;
  inset: 0;
  background-position: center;
  background-size: cover;
  filter: blur(8px) saturate(1.05) contrast(0.9);
  transform: scale(1.06);
  z-index: 1000;
  transition: filter 400ms ease, opacity 400ms ease;
  opacity: 1;
}

/* overlay oscuro encima de la bg para mejorar contraste */
#auth-bg-dim {
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(3,7,18,0.6), rgba(3,7,18,0.75));
  z-index: 1001;
}

/* tarjeta tipo "album" */
#auth-card {
  position: relative;
  z-index: 1002;
  width: 760px;
  max-width: 94%;
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 20px;

  border-radius: 14px;
  padding: 22px;
  box-shadow: 0 20px 60px rgba(2,6,23,0.7);
  color: #fff;
  align-items: center;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.04);
}

/* columna izquierda (arte de √°lbum) */
#auth-art {
  width: 100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
}
#auth-art .cover {
  width: 220px;
  height: 220px;
  border-radius: 12px;
  background-size: cover;
  background-position: center;
  box-shadow: 0 12px 30px rgba(0,0,0,0.6);
  border: 1px solid rgba(255,255,255,0.04);
}
#auth-art .badge {
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-weight:700;
  font-size:14px;
  color:#ffd166;
}

/* columna derecha (form) */
#auth-card .heading { font-size:20px; font-weight:800; letter-spacing: -0.2px; }
#auth-card .sub { color: #9ca3af; font-size:13px; margin-top:6px; }

.auth-input {
  width:100%;
  padding:12px 14px;
  border-radius:10px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.04);
  color: #fff;
  margin-top:10px;
  outline: none;
  transition: box-shadow 200ms, border-color 200ms;
}
.auth-input:focus { box-shadow: 0 6px 18px rgba(15, 23, 42, 0.5); border-color: rgba(99,102,241,0.45); }

#auth-submit {
    background: linear-gradient(90deg, #d1ac56, #4c5968);
    color: #021124;
    padding: 12px 18px;
    border-radius: 10px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    margin-top: 12px;
    transition: transform 140ms 
cubic-bezier(.2, .9, .2, 1);
}
#auth-submit:active { transform: translateY(1px) scale(.997); }

/* mini ecualizador animado al lado del bot√≥n */
.eq-bars { display:inline-flex; gap:6px; align-items:end; height:20px; margin-left:8px; }
.eq-bars span { width:4px; background: linear-gradient(180deg,#ffd166,#ef476f); border-radius:3px; transform-origin: bottom; animation: eqUp 900ms infinite ease-in-out; opacity:.95; }
.eq-bars span:nth-child(1){ animation-delay: 0ms; }
.eq-bars span:nth-child(2){ animation-delay: 120ms; }
.eq-bars span:nth-child(3){ animation-delay: 240ms; }

@keyframes eqUp {
  0% { transform: scaleY(.25); }
  30% { transform: scaleY(1.0); }
  60% { transform: scaleY(.45); }
  100% { transform: scaleY(.25); }
}

/* texto de error/ayuda */
#auth-error { color: #ff8a8a; font-size:13px; margin-top:8px; min-height:18px; }

/* responsivo: en pantallas peque√±as la tarjeta se convierte en columna */
@media (max-width: 720px) {
  #auth-card { grid-template-columns: 1fr; padding: 16px; gap: 12px; }
  #auth-art .cover { width: 160px; height:160px; }
  .eq-bars { display:none; }
}

/* === ICONS PARA INPUTS y BOT√ìN (a√±adir) === */
.input-with-icon { position: relative; margin-top:10px; }
.input-icon-left { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width:18px; height:18px; color: #9ca3af; opacity: 0.95; pointer-events: none; }
.auth-input.with-left-icon { padding-left: 44px; padding-right: 44px; } /* espacio para icono izquierdo y bot√≥n derecho */

.icon-button { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); border: 0; background: rgba(255,255,255,0.02); color: #cbd5e1; padding:6px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
.icon-button svg { width:18px; height:18px; }
.icon-button:focus { outline: 2px solid rgba(124,58,237,0.24); box-shadow: 0 6px 18px rgba(99,102,241,0.08); }

.input-icon-left + .auth-input.with-left-icon { /* cuando el input viene justo despu√©s del SVG por estructura DOM */ }

    </style>
</head>

<body class="bg-gray-900 text-white h-full overflow-hidden flex flex-col">

<!-- AUTH OVERLAY (LOGIN MUSICAL - ICONOS) -->
<div id="auth-overlay" class="hidden" aria-hidden="true" role="dialog" aria-labelledby="auth-title" aria-modal="true">
  <div id="auth-bg-image" aria-hidden="true" style="background-image:url('https://iili.io/KiUJydX.png');"></div>
  <div id="auth-bg-dim" aria-hidden="true"></div>

  <div id="auth-card">
    <div id="auth-art">
      <div class="cover" id="auth-cover" style="background-image: url('https://iili.io/KiUJydX.png');"></div>
      <div class="badge">üéµ SYSACCESSVIP</div>
      <div style="font-size:12px;color:#9ca3af;text-align:center;max-width:220px">Accede a tu cuenta para sincronizar playlists, favoritos y continuar reproduciendo donde dejaste.</div>
    </div>

    <div>

      <form id="auth-form" autocomplete="on" style="margin-top:12px">
        <!-- EMAIL con √≠cono -->
        <label class="sr-only">Correo</label>
        <div class="input-with-icon">
          <!-- ICONO USUARIO (SVG) -->
          <svg class="input-icon-left" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M3 21c0-3.866 3.582-7 9-7s9 3.134 9 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          <input id="auth-email" class="auth-input with-left-icon" type="email" required placeholder="tu@correo.com" />
        </div>

        <!-- PASSWORD con √≠cono y bot√≥n mostrar/ocultar (SVG) -->
        <label class="sr-only">Contrase√±a</label>
        <div class="input-with-icon" style="position:relative;">
          <!-- ICONO CANDADO (SVG) -->
          <svg class="input-icon-left" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="3" y="11" width="18" height="10" rx="2" stroke="currentColor" stroke-width="1.5"></rect>
            <path d="M7 11V8a5 5 0 0110 0v3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>

          <input id="auth-password" class="auth-input with-left-icon" type="password" required placeholder="Contrase√±a" />

          <!-- BOT√ìN ICONO PARA MOSTRAR / OCULTAR CONTRASE√ëA -->
          <button id="toggle-password-visibility" type="button" class="icon-button" title="Mostrar contrase√±a" aria-pressed="false" aria-label="Mostrar contrase√±a">
            <!-- ICONO EYE (por defecto: mostrar) -->
            <svg id="eye-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7S3.732 16.057 2.458 12z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5"></circle>
            </svg>
          </button>
        </div>

        <div id="auth-error"></div>

        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;gap:12px">
          <div style="font-size:12px;color:#9ca3af">Intentos: <strong id="auth-attempts">3</strong></div>
          <div style="display:flex;align-items:center;gap:8px">
            <button id="auth-submit" type="submit">Entrar
              <span class="eq-bars" aria-hidden="true"><span></span><span></span><span></span></span>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- /AUTH OVERLAY -->


    <div id="sidebar-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden"></div>
    <div id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-gray-800 z-50 shadow-lg transform -translate-x-full"><div class="p-4 flex justify-between items-center"><h2 class="text-xl font-bold">Men√∫</h2><button id="close-sidebar-btn" class="p-2 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" ></path></svg></button></div><nav class="mt-4"><a href="#" class="nav-link flex items-center p-4 text-lg hover:bg-gray-700" data-page="home"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1V9a1 1 0 011-1h2a1 1 0 011 1v10a1 1 0 001 1m-6 0h6" ></path></svg>Inicio</a><a href="#" class="nav-link flex items-center p-4 text-lg hover:bg-gray-700" data-page="favorites"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 19.5l-7.682-7.682a4.5 4.5 0 010-6.364z" ></path></svg>Favoritos</a><a href="#" class="nav-link flex items-center p-4 text-lg hover:bg-gray-700" data-page="recents"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6 1a9 9 0 11-18 0 9 9 0 0118 0z" ></path></svg>Recientes</a><a href="#" class="nav-link flex items-center p-4 text-lg hover:bg-gray-700" data-page="library"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v-4l-4 4m0 0l4 4m-4-4h16" ></path><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 18h16" ></path></svg>Biblioteca</a>
            <!-- Cerrar sesi√≥n agregado -->
            <a href="#" id="logout-link" class="flex items-center p-4 text-lg hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" ></path></svg>Cerrar sesi√≥n</a>
        </nav></div>
    <div id="main-content" class="flex-1 flex flex-col overflow-hidden relative"><header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-30 flex items-center p-4 shadow-md"><button id="open-sidebar-btn" class="p-2 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" ></path></svg></button><div class="flex-1 mx-4"><div class="relative"><input type="search" id="search-input" class="w-full bg-gray-700 text-white rounded-full py-2 px-4 pl-10" placeholder="Buscar canciones, artistas o playlists..."><div class="absolute left-3 top-1/2 -translate-y-1/2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" ></path>
    
    </svg>
  </div></div></div><div class="flex gap-2"><button id="search-button" class="p-2 rounded-full bg-blue-600 hover:bg-blue-500" title="Buscar v√≠deos"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" ></path></svg></button><button id="search-playlists-button" class="p-2 rounded-full bg-green-600 hover:bg-green-500" title="Buscar playlists">
    
    
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
        d="M4 6h16M4 10h12m0 0v6a2 2 0 11-2-2h2m-12 0h6">
  </path>
</svg>

  
  </button></div></header>
    <main id="page-container" class="flex-1 overflow-y-auto pb-24"><div id="page-home" class="page active p-4"><h1 id="home-title" class="text-3xl font-bold mb-6">Inicio</h1><div id="results-container" class="mb-6"></div><div id="home-categories-section" class="mb-6"><h2 class="text-2xl font-semibold mb-4">Categor√≠as</h2><div class="flex space-x-3 overflow-x-auto pb-2"><button class="category-btn flex-shrink-0 px-4 py-2 bg-gray-700 rounded-full font-medium" data-category="Rock">Rock</button><button class="category-btn flex-shrink-0 px-4 py-2 bg-gray-700 rounded-full font-medium" data-category="Pop">Pop</button><button class="category-btn flex-shrink-0 px-4 py-2 bg-gray-700 rounded-full font-medium" data-category="Latin">Latino</button><button class="category-btn flex-shrink-0 px-4 py-2 bg-gray-700 rounded-full font-medium" data-category="Hip Hop">Hip Hop</button><button class="category-btn flex-shrink-0 px-4 py-2 bg-gray-700 rounded-full font-medium" data-category="Electronic">Electr√≥nica</button></div></div><div id="home-playlists-section" class="mb-6"><h2 class="text-2xl font-semibold mb-4">Playlists (YouTube)</h2><div id="playlists-container" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div></div><div id="home-popular-section"><h2 class="text-2xl font-semibold mb-4">M√∫sica Popular</h2><div id="popular-music-container"></div></div></div><div id="page-favorites" class="page p-4"><h1 class="text-3xl font-bold mb-6">Mis Favoritos</h1><div id="favorites-container"></div></div><div id="page-recents" class="page p-4"><h1 class="text-3xl font-bold mb-6">Recientes</h1><div id="recents-container"></div></div><div id="page-library" class="page p-4"><h1 class="text-3xl font-bold mb-6">Mi Biblioteca</h1><div id="library-container"></div></div>
    <div id="page-playlist-details" class="page overflow-y-auto relative"><button id="playlist-back-btn" class="absolute top-4 left-4 z-30 p-2 rounded-full bg-black/50 hover:bg-black/70"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" ></path></svg></button><div id="playlist-sticky-header"><h2 id="playlist-sticky-title" class="text-xl font-bold truncate">Playlist</h2></div><div id="playlist-header"><div id="playlist-info"><h1 id="playlist-title" class="text-4xl font-extrabold"></h1><p id="playlist-channel" class="text-gray-300 mt-1"></p></div></div><div id="playlist-songs-container" class="p-4 bg-gray-850"></div></div></main></div>

    <div id="full-player" class="fixed inset-0 bg-gray-800 z-50 flex flex-col transform translate-y-full overflow-hidden">
        
        <div id="player-bg-image" class="absolute inset-0 w-full h-full bg-cover bg-center transition-all duration-500 z-0" style="filter: blur(24px); opacity: 0.3; transform: scale(1.2);"></div>

        <header class="relative z-10 p-4 flex items-center space-x-2 flex-shrink-0">
            <button id="minimize-player-btn" class="p-2 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" ></path></svg></button>
            <span class="flex-1 text-center font-semibold">Reproduciendo</span>
            <div class="flex items-center gap-2">
                <button id="fav-btn-full" class="p-2 rounded-full hover:bg-gray-700"><svg id="fav-icon-full" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 19.5l-7.682-7.682a4.5 4.5 0 010-6.364z" ></path></svg></button>
                <button id="library-options-btn" class="p-2 rounded-full hover:bg-gray-700" title="Opciones de biblioteca"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" ></path></svg></button>
            </div>
        </header>

        <div id="player-main-view" class="relative z-10 flex-1 flex flex-col items-center justify-center p-4 min-h-0">
            <div class="w-full max-w-md relative">
                <div id="player-video-container" class="w-full bg-black rounded-lg overflow-hidden shadow-lg">
                    <div id="yt_visible"></div>
                    <button id="fullscreen-btn" class="absolute bottom-2 right-2 p-2 bg-black/50 rounded-full text-white hover:bg-black/70 z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" ></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="relative z-10 p-4 text-center flex-shrink-0">
            <div class="marquee-container"><h3 id="player-title" class="text-xl font-bold marquee-text">T√≠tulo de la Canci√≥n</h3></div>
            <p id="player-artist" class="text-gray-400">Nombre del Artista</p>
        </div>
        
        <div class="relative z-10 px-6 flex-shrink-0">
            <input type="range" id="player-progress-bar" value="0" step="1">
            <div class="flex justify-between text-xs font-mono mt-1">
                <span id="player-current-time">0:00</span>
                <span id="player-total-duration">0:00</span>
            </div>
        </div>

        <div class="relative z-10 p-4 pb-6 flex-shrink-0">
            <div class="flex justify-evenly items-center">
                <button id="shuffle-btn" class="p-2 rounded-full hover:bg-gray-700 text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5" ></path></svg></button>
                <button id="prev-btn" class="p-2 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" ></path></svg></button>
                <button id="play-pause-btn" class="w-16 h-16 bg-white text-gray-900 rounded-full flex items-center justify-center shadow-lg"><svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" ></path></svg><svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1z" clip-rule="evenodd" ></path></svg></button>
                <button id="next-btn" class="p-2 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" ></path></svg></button>
                <button id="loop-btn" class="p-2 rounded-full hover:bg-gray-700 text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2A8.001 8.001 0 0019.418 15m0 0H15" ></path></svg></button>
            </div>
        </div>

        <div id="queue-trigger-area" class="relative z-10 text-center pb-4 flex-shrink-0 cursor-n-resize" style="touch-action: none;">
            <button id="show-queue-panel-btn" class="p-2 text-gray-400" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" ></path></svg>
            </button>
        </div>

        <div id="player-queue-panel">
            <div id="player-queue-handle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" ></path></svg>
            </div>
            <h3 class="text-lg font-semibold text-center px-4">Cola de Reproducci√≥n</h3>
            <div id="player-queue-list" class="flex-1 overflow-y-auto p-2"></div>
        </div>
    </div>
    <div id="mini-player" class="fixed bottom-0 left-0 right-0 bg-gray-700 h-16 flex items-center p-2 shadow-lg transform translate-y-full opacity-0 z-40"><div class="flex-1 flex items-center truncate" id="maximize-player-btn"><img id="mini-player-thumb" src="https://placehold.co/40x40/000000/FFFFFF?text=?" alt="thumbnail" class="w-10 h-10 rounded mr-3"><div class="truncate"><div class="marquee-container"><p id="mini-player-title" class="font-medium marquee-text-mini">No hay nada sonando</p></div><p id="mini-player-artist" class="text-sm text-gray-300 truncate">...</p></div></div>
    
<button id="mini-play-pause-btn" class="p-2 rounded-full hover:bg-gray-600" aria-label="Play / Pause">
  <!-- Ecualizador (animaci√≥n cuando reproduce) -->
  <div class="mini-eq" aria-hidden="true">
    <span class="bar b1"></span>
    <span class="bar b2"></span>
    <span class="bar b3"></span>
  </div>

  <!-- Animaci√≥n de "pause" (dos barras que aparecen) -->
  <div class="mini-pause-anim" aria-hidden="true">
    <span class="p1"></span>
    <span class="p2"></span>
  </div>

  <!-- SVGs originales (seguimos us√°ndolos para fallbacks/accessibility) -->
  <svg id="mini-play-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hidden" fill="currentColor" viewBox="0 0 20 20">
    <path d="M9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path>
  </svg>
  <svg id="mini-pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hidden" fill="currentColor" viewBox="0 0 20 20">
    <path d="M8 7a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1z"></path>
  </svg>
</button>


</div>
    <div id="player-iframe-wrapper" class="fixed -z-10 -top-full -left-full"><div id="yt_hidden_holder"></div></div>
    <div id="toast-root"></div>

    <script type="module">

      
    /*****************************************************************
     * Firebase + App code (modular)
     *****************************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    // Agregar justo despu√©s de las importaciones existentes
import { getDatabase, ref, runTransaction, get, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";



    // Tu configuraci√≥n de Firebase (la que proporcionaste)
    const firebaseConfig = {
      apiKey: "AIzaSyBbwYJ-92cBn3HUoP_raSdMeriKDTWTlj4",
      authDomain: "data-client-5.firebaseapp.com",
      databaseURL: "https://data-client-5-default-rtdb.firebaseio.com",
      projectId: "data-client-5",
      storageBucket: "data-client-5.firebasestorage.app",
      messagingSenderId: "926346130667",
      appId: "1:926346130667:web:a91b7261b457f2137a3aae",
      measurementId: "G-ETCV9ZMZ5Q"
    };


// CONTACTO DEL PROVEEDOR (editar aqu√≠ con tu correo o tel√©fono)
const PROVIDER_CONTACT = {
  email: "sysaccessvip@gmail.com",   // Cambia esto por el correo real del proveedor
  phone: "+51960436357"         // Opcional: n√∫mero telef√≥nico (cadena). Borra o deja vac√≠o si no usas.
};


    // Initialize Firebase
    const firebaseApp = initializeApp(firebaseConfig);
    const analytics = getAnalytics(firebaseApp);
    const auth = getAuth(firebaseApp);

    // CONFIG original
const CONFIG = {
  YT_MAX_RESULTS: 15,
  API_KEYS: [
    "AIzaSyCzu-Mqx22V83ktalXksUnC1AhtZwzyb-0",
    "AIzaSyBM-uvKMHe5GxNuMpWB45-RWVUGYOGwEyQ",
    "AIzaSyAd6JdvYn7YGMfSY9EaJtCEUGd11tKa6ZI",
    "AIzaSyBr2nxeKaN1q07fMV59zrLEOQx9dzYBsMI",
    "AIzaSyBbnepAY-irFm35H7Qu0NrwISzLCThkBKM",
    "AIzaSyAujlR4Gig8puLuzM-amckcwu5sbMRvIR0",
    "AIzaSyBiGJ9JeOdkrUI7x-qQHyrHpUJAxcwRTvI",
    "AIzaSyC_UCUc3zcffX5_IOPFpqbJyXmUYxKOg9U",
    "AIzaSyC7FYbsVmGA0LnepHG7t_xPOR0mEkQ1jiE",
    "AIzaSyBLTPa7EUAmnJZMq4sYBT97x4HY3--YHws",
    "AIzaSyDWAi-0_oqg5GHwEoE0_LnSLSV_nsfs1SI",
    "AIzaSyBJ6zZI3BFvBd02EcdsJFE7dLdZ-f7RV9c",
    "AIzaSyD_9Flh18VT4hJ0OkEIS3TCECJ4vIOcfC0",
    "AIzaSyC3_rIZ5deseDbte7auVOo7oUDjopEMaBg",


"AIzaSyDSzaurar6qWbtX5jLxz1PbmA-kWyF7lzs",
 "AIzaSyCWAoeccPIoY4IYkWjErOtmrkrl_okWVAU",
 "AIzaSyBd96Y3c6RlfhtZZy5rrokWCsMNB5i3PfY",
 "AIzaSyBVj3MZejLw-CJSDQGBiDzzB27y6HZYdMI",
 "AIzaSyBY1KQn5kFZwiWV3_MWQhdXzbM5M3F-uvg",
 "AIzaSyA61v0Q6T3OnDSl0-COr-kOFTr4s8_QINc",
 "AIzaSyBIvdLnLnEhxLBT-k87kAr9Soq4XTkm-Fg",
 "AIzaSyDp2P-s7j00NqmEdUwqbaKDHagx6AnXndE",
  "AIzaSyBRvt3wJ0M_HZXlCatSNWTyQWp2iaR-Ak4",
 "AIzaSyA8QrIvfGwrOYxtTYz54vBJF6yGsbKdC9c",
 "AIzaSyC2jfpcfwlfyrug-7_1_ZkEnmJL8riVLTg",
 "AIzaSyCtqatmr5k4xzE5QFJMf1nt9c-Dcthxjuk",



    "AIzaSyA9jC-p2NtbeppL8x0YKQqNkrdOggt3Q48"
  ],
  STORAGE_PREFIX: 'mp_'
};

const state = {


  
  visiblePlayer: null,
  hiddenPlayer: null,
  playersReady: false,
  pendingPlay: null,
  queuedTrack: null,
  currentKeyIndex: 0,
  currentTrack: null,
  currentQueue: [],
  currentQueueIndex: 0,
  favorites: [],
  libraries: [],
  recents: [],
  currentPage: 'home',
  isShuffle: false,
  isLoop: false,
  transferInProgress: false,
  isPlaying: false,
  lastPage: 'home',
  isSeeking: false,
  progressInterval: null,
  touchStartY: 0,
  touchMoveY: 0
};

    // ==== INICIO DE CAMBIO 2 (JS - dom) ====
    const dom = {
        sidebar: document.getElementById('sidebar'), sidebarBackdrop: document.getElementById('sidebar-backdrop'), openSidebarBtn: document.getElementById('open-sidebar-btn'), closeSidebarBtn: document.getElementById('close-sidebar-btn'), navLinks: document.querySelectorAll('.nav-link'), pageContainer: document.getElementById('page-container'), pages: document.querySelectorAll('.page'), homeTitle: document.getElementById('home-title'),
        searchInput: document.getElementById('search-input'), searchButton: document.getElementById('search-button'), searchPlaylistsButton: document.getElementById('search-playlists-button'), categoryButtons: document.querySelectorAll('.category-btn'),
        popularMusicContainer: document.getElementById('popular-music-container'), resultsContainer: document.getElementById('results-container'), favoritesContainer: document.getElementById('favorites-container'), playlistsContainer: document.getElementById('playlists-container'), libraryContainer: document.getElementById('library-container'), recentsContainer: document.getElementById('recents-container'),
        homeCategoriesSection: document.getElementById('home-categories-section'), homePlaylistsSection: document.getElementById('home-playlists-section'), homePopularSection: document.getElementById('home-popular-section'),
        fullPlayer: document.getElementById('full-player'), minimizePlayerBtn: document.getElementById('minimize-player-btn'), playerVideoContainer: document.getElementById('player-video-container'), playerTitle: document.getElementById('player-title'), playerArtist: document.getElementById('player-artist'), favBtnFull: document.getElementById('fav-btn-full'), favIconFull: document.getElementById('fav-icon-full'), libraryOptionsBtn: document.getElementById('library-options-btn'),
        playerBgImage: document.getElementById('player-bg-image'), // <--- NUEVO ELEMENTO A√ëADIDO
        playPauseBtn: document.getElementById('play-pause-btn'), playIcon: document.getElementById('play-icon'), pauseIcon: document.getElementById('pause-icon'), nextBtn: document.getElementById('next-btn'), prevBtn: document.getElementById('prev-btn'), shuffleBtn: document.getElementById('shuffle-btn'), loopBtn: document.getElementById('loop-btn'),
        miniPlayer: document.getElementById('mini-player'), maximizePlayerBtn: document.getElementById('maximize-player-btn'), miniPlayerThumb: document.getElementById('mini-player-thumb'), miniPlayerTitle: document.getElementById('mini-player-title'), miniPlayerArtist: document.getElementById('mini-player-artist'), miniPlayPauseBtn: document.getElementById('mini-play-pause-btn'), miniPlayIcon: document.getElementById('mini-play-icon'), miniPauseIcon: document.getElementById('mini-pause-icon'),
        playerIframeWrapper: document.getElementById('player-iframe-wrapper'), ytVisibleHolder: document.getElementById('yt_visible'), ytHiddenHolder: document.getElementById('yt_hidden_holder'), toastRoot: document.getElementById('toast-root'),
        playlistPage: document.getElementById('page-playlist-details'), playlistHeader: document.getElementById('playlist-header'), playlistStickyHeader: document.getElementById('playlist-sticky-header'), playlistStickyTitle: document.getElementById('playlist-sticky-title'), playlistTitle: document.getElementById('playlist-title'), playlistChannel: document.getElementById('playlist-channel'), playlistSongsContainer: document.getElementById('playlist-songs-container'), playlistBackBtn: document.getElementById('playlist-back-btn'),
        playerProgressBar: document.getElementById('player-progress-bar'), playerCurrentTime: document.getElementById('player-current-time'), playerTotalDuration: document.getElementById('player-total-duration'),
        playerQueuePanel: document.getElementById('player-queue-panel'), 
        showQueuePanelBtn: document.getElementById('show-queue-panel-btn'),
        queueTriggerArea: document.getElementById('queue-trigger-area'),
        playerQueueHandle: document.getElementById('player-queue-handle'),
        playerQueueList: document.getElementById('player-queue-list'), 
        playerMainView: document.getElementById('player-main-view'),
        fullscreenBtn: document.getElementById('fullscreen-btn'),
        
    };

// Variable para mantener mensajes forzados desde admin (cuando se deshabilita/expira)
window._forcedAuthMessage = null;


// === Preload y setup del background del login (evitar flash) ===
(function preloadAuthBg(){
  try {
    const defaultBg = 'https://cdn.pixabay.com/photo/2016/08/01/15/47/music-1561355_1280.jpg';
    const img = new Image();
    img.onload = () => {
      const el = document.getElementById('auth-bg-image');
      if (el) { el.style.backgroundImage = `url('${defaultBg}')`; el.style.opacity = '1'; }
    };
    img.src = defaultBg;
    // tambi√©n precargamos la portada circular (opcional)
    const cover = new Image();
    cover.onload = () => {
      const c = document.getElementById('auth-cover');
      if (c) c.style.backgroundImage = `url('${cover.src}')`;
    };
    cover.src = 'https://iili.io/KiUzAQt.png';
  } catch(e){ console.warn('preloadAuthBg err', e); }
})();


    // ==== FIN DE CAMBIO 2 (JS - dom) ====
// estado visual inicial del mini bot√≥n: pausado (ecualizador quieto y animaci√≥n de pause visible)
dom.miniPlayPauseBtn?.classList.add('mini-paused');
const initialEq = dom.miniPlayPauseBtn?.querySelector('.mini-eq');
if (initialEq) initialEq.style.display = 'none';


// A√±adir justo despu√©s de la definici√≥n de `dom` (o en la secci√≥n de elementos y l√≥gica de autenticaci√≥n)
dom.authSubmit = document.getElementById('auth-submit'); // referencia al bot√≥n de login
let authVerifying = false; // bandera para evitar carreras


    // ---------- ELEMENTOS Y LOGICA DE AUTENTICACI√ìN ----------
    dom.authOverlay = document.getElementById('auth-overlay');
    dom.authForm = document.getElementById('auth-form');
    dom.authEmail = document.getElementById('auth-email');
    dom.authPassword = document.getElementById('auth-password');
    dom.togglePasswordBtn = document.getElementById('toggle-password-visibility');
    dom.authError = document.getElementById('auth-error');
    dom.authAttempts = document.getElementById('auth-attempts');
    dom.logoutLink = document.getElementById('logout-link');

    const AUTH_KEY = `${CONFIG.STORAGE_PREFIX}auth_lock`;
    function getAuthLock() {
      const raw = localStorage.getItem(AUTH_KEY);
      if (!raw) return { attempts: 3, lockedUntil: 0 };
      try { return JSON.parse(raw); } catch { return { attempts: 3, lockedUntil: 0 }; }
    }
    function saveAuthLock(obj) { localStorage.setItem(AUTH_KEY, JSON.stringify(obj)); }
    function resetAuthLock() { saveAuthLock({ attempts: 3, lockedUntil: 0 }); }
    function decreaseAttempt() {
      const lock = getAuthLock();
      lock.attempts = Math.max(0, (lock.attempts || 3) - 1);
      if (lock.attempts === 0) lock.lockedUntil = Date.now() + (10 * 60 * 1000); // 10 minutos
      saveAuthLock(lock);
    }
    function getAttemptsLeft() {
      const lock = getAuthLock();
      const now = Date.now();
      if (lock.lockedUntil && now < lock.lockedUntil) return 0;
      return lock.attempts || 3;
    }
    function getLockedRemainingMs() {
      const lock = getAuthLock();
      const now = Date.now();
      return lock.lockedUntil && lock.lockedUntil > now ? (lock.lockedUntil - now) : 0;
    }


// ======= Inicio: Device binding helpers (agregar) =======
const DEVICE_ID_KEY = `${CONFIG.STORAGE_PREFIX}device_id`;

function getOrCreateDeviceId() {
  try {
    let id = localStorage.getItem(DEVICE_ID_KEY);
    if (id) return id;
    // usar crypto.randomUUID si est√° disponible
    if (window.crypto && crypto.randomUUID) id = crypto.randomUUID();
    else id = 'dev-' + Math.random().toString(36).slice(2, 12);
    localStorage.setItem(DEVICE_ID_KEY, id);
    return id;
  } catch (e) {
    console.warn('getOrCreateDeviceId error', e);
    // fallback simple
    const fallback = 'dev-' + Date.now();
    try { localStorage.setItem(DEVICE_ID_KEY, fallback); } catch(e){}
    return fallback;
  }
}

/**
 * checkAndBindDevice(user)
 * - Si no existe deviceLocks/{uid} -> lo crea con el deviceId local (commit)
 * - Si existe y coincide -> permite
 * - Si existe y NO coincide -> revierte sesi√≥n (signOut) y deniega el acceso
 * Devuelve true si permitimos el acceso, false si denegamos.
 */
async function checkAndBindDevice(user) {
  if (!user || !user.uid) return false;
  try {
    const db = getDatabase(firebaseApp);
    const uid = user.uid;
    const lockRef = ref(db, `deviceLocks/${uid}`);
    const localId = getOrCreateDeviceId();

    const result = await runTransaction(lockRef, (current) => {
      // Si no hay registro, crearlo atomically
      if (current === null) {
        return {
          deviceId: localId,
          createdAt: Date.now(),
          userAgent: navigator.userAgent || '',
        };
      }
      // si ya existe, devolvemos undefined para no modificar (abort)
      return;
    });

    // result -> { committed: boolean, snapshot: DataSnapshot }
    if (result && result.committed) {
      // Se cre√≥ el enlace al dispositivo (primer inicio en este uid)
      console.log('Device binding creado:', localId);
      return true;
    } else {
      // no se cre√≥: existe un registro previo
      const snap = result && result.snapshot;
      const existing = snap ? snap.val() : null;
      if (existing && existing.deviceId === localId) {
        // es el mismo dispositivo: permitir
        return true;
      } else {
        // distinto dispositivo: denegar y cerrar sesi√≥n
        console.warn('Acceso denegado: usuario ya vinculado a otro dispositivo', existing);
        try { await firebaseSignOut(auth); } catch(e){}
        showAuthOverlay(true, 'Acceso denegado: esta cuenta ya est√° registrada en otro dispositivo.');
        return false;
      }
    }
  } catch (e) {
    console.error('checkAndBindDevice error', e);
    // En caso de error al verificar la DB, denegar por seguridad
    try { await firebaseSignOut(auth); } catch(e){}
    showAuthOverlay(true, 'Error al verificar dispositivo. Intenta m√°s tarde.');
    return false;
  }
}
// ======= Fin: Device binding helpers (agregar) =======


// FORZAR cierre en caso de cambios manuales (opcional / robusto)
function subscribeUserMetaChanges(uid) {
  try {
    const db = getDatabase(firebaseApp);
    const metaRef = ref(db, `userMeta/${uid}`);
    return onValue(metaRef, (snap) => {
      const meta = snap.val();
      const now = Date.now();
      if (!meta) return;
      if (meta.disabled || (meta.expiresAt && Number(meta.expiresAt) <= now)) {
        // Forzamos cierre
        try { firebaseSignOut(auth); } catch(e){ console.warn('signOut forced', e); }
        const msg = meta.disabled ? 'Cuenta deshabilitada. Contacta soporte.' : 'Suscripci√≥n expirada. Renueva para volver a ingresar.';
        showAuthOverlay(true, msg);
      }
    });
  } catch (e) { console.warn('subscribeUserMetaChanges err', e); }
}



    let appInitialized = false; // control para initApp()

function showAuthOverlay(show = true, messageHTML = '', processing = false) {
  if (!dom.authOverlay) return;

  if (show) {
    // Si se pas√≥ un mensaje expl√≠cito lo usamos y lo guardamos como forced (para persistencia).
    // Si no se pas√≥ mensaje expl√≠cito (messageHTML === ''), mostramos el forced message si existe.
    if (messageHTML && messageHTML.length) {
      // guardamos como forced message para que persista despu√©s del signOut
      window._forcedAuthMessage = messageHTML;
    }

    // Determinar contenido a mostrar: preferir messageHTML; si est√° vac√≠o, usar forced si existe
    const contentToShow = (messageHTML && messageHTML.length) ? messageHTML : (window._forcedAuthMessage || '');

    dom.authOverlay.classList.remove('hidden');
    try {
      dom.authError.innerHTML = contentToShow;
    } catch (e) {
      dom.authError.textContent = contentToShow;
    }

    const left = getAttemptsLeft();
    dom.authAttempts.textContent = left;

    // processing UI
    if (processing) {
      authVerifying = true;
      if (dom.authForm) {
        Array.from(dom.authForm.elements || []).forEach(el => { try { el.disabled = true; } catch(e){} });
      }
      if (dom.authSubmit) {
        dom.authSubmit.dataset.origText = dom.authSubmit.textContent || '';
        dom.authSubmit.textContent = 'Verificando...';
      }
    } else {
      authVerifying = false;
      if (dom.authForm) {
        Array.from(dom.authForm.elements || []).forEach(el => { try { el.disabled = false; } catch(e){} });
      }
      if (dom.authSubmit && dom.authSubmit.dataset.origText) {
        dom.authSubmit.textContent = dom.authSubmit.dataset.origText;
        delete dom.authSubmit.dataset.origText;
      }
    }

  } else {
    // Ocultar overlay: limpiamos el forced message para no reaparecerlo
    dom.authOverlay.classList.add('hidden');
    dom.authError.innerHTML = '';
    authVerifying = false;
    if (dom.authForm) {
      Array.from(dom.authForm.elements || []).forEach(el => { try { el.disabled = false; } catch(e){} });
    }
    if (dom.authSubmit && dom.authSubmit.dataset.origText) {
      dom.authSubmit.textContent = dom.authSubmit.dataset.origText;
      delete dom.authSubmit.dataset.origText;
    }
    // limpia mensaje forzado (quitar si prefieres conservar hasta reactivaci√≥n manual)
    window._forcedAuthMessage = null;
  }
}



// ICONOS SVG (strings) para alternar
const EYE_SVG = `<svg id="eye-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <path d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7S3.732 16.057 2.458 12z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
  <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5"></circle>
</svg>`;

const EYE_OFF_SVG = `<svg id="eye-off-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <path d="M3 3l18 18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
  <path d="M10.58 10.58A3 3 0 0013.42 13.42" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
  <path d="M2.458 12C3.732 7.943 7.523 5 12 5c1.37 0 2.675.28 3.854.78" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
  <path d="M21.542 12C20.268 16.057 16.477 19 12 19c-1.37 0-2.675-.28-3.854-.78" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>`;

dom.togglePasswordBtn?.addEventListener('click', () => {
  if (!dom.authPassword || !dom.togglePasswordBtn) return;
  const p = dom.authPassword;
  const willShow = (p.type === 'password');
  p.type = willShow ? 'text' : 'password';
  // actualizar apariencia del bot√≥n
  dom.togglePasswordBtn.setAttribute('aria-pressed', String(willShow));
  dom.togglePasswordBtn.title = willShow ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a';
  dom.togglePasswordBtn.innerHTML = willShow ? EYE_OFF_SVG : EYE_SVG;
});


dom.authForm?.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  if (!dom.authEmail || !dom.authPassword) return;
  const email = dom.authEmail.value.trim();
  const pass = dom.authPassword.value;
  const lockedMs = getLockedRemainingMs();
  if (lockedMs > 0) {
    const mins = Math.ceil(lockedMs / 60000);
    dom.authError.textContent = `Bloqueado por intentos. Intenta en ${mins} minuto(s).`;
    return;
  }
  if (!email || !pass) {
    dom.authError.textContent = 'Correo y contrase√±a requeridos.';
    return;
  }

  try {
    // Intentamos autenticar. **No** inicializamos la app aqu√≠.
    // Importante: mostramos la UI de "verificando" inmediatamente despu√©s del signIn para bloquear la UI.
    await signInWithEmailAndPassword(auth, email, pass);

    // Dejar el overlay visible en modo processing: onAuthStateChanged har√° la verificaci√≥n y llamar√° a initApp si corresponde.
    showAuthOverlay(true, 'Verificando dispositivo...', true);

    // NOTA: no hacemos resetAuthLock aqu√≠. Esperamos a que la verificaci√≥n de device sea exitosa (onAuthStateChanged).
  } catch (err) {
    console.error('Login error', err);
    decreaseAttempt();
    const left = getAttemptsLeft();
    if (left === 0) {
      const locked = getLockedRemainingMs();
      const mins = Math.ceil(locked / 60000);
      dom.authError.textContent = `Has sido bloqueado por demasiados intentos. Espera ${mins} minuto(s).`;
    } else {
      dom.authError.textContent = `Credenciales incorrectas. Intentos restantes: ${left}`;
    }
    dom.authAttempts.textContent = left;
  }
});


    dom.logoutLink?.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        try { const active = getActivePlayer(); if (active && active.pauseVideo) active.pauseVideo(); } catch(e){}
        await firebaseSignOut(auth);
        // onAuthStateChanged se encargar√° de mostrar overlay y detener la app
      } catch (err) {
        console.warn('Logout error', err);
        showToast('Error al cerrar sesi√≥n.');
      }
    });

    /*****************************************************************
     * C√≥digo original (YouTube players, UI, funciones)
     *****************************************************************/
    (function loadYT(){ if (!window.YT) { const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; document.body.appendChild(tag); } else if (window.YT && window.YT.Player) { if (typeof window.onYouTubeIframeAPIReady === 'function') window.onYouTubeIframeAPIReady(); } })();
    window.onYouTubeIframeAPIReady = function() { try { state.visiblePlayer = new YT.Player(dom.ytVisibleHolder, { height: '100%', width: '100%', playerVars: {'playsinline':1,'controls':0,'disablekb':1,'modestbranding':1,'rel':0,'showinfo':0}, events: {'onReady': onVisibleReady,'onStateChange': onPlayerStateChange,'onError': (e) => console.warn("visiblePlayer error", e)}}); state.hiddenPlayer = new YT.Player(dom.ytHiddenHolder, { height: '1', width: '1', playerVars: {'playsinline':1,'controls':0,'disablekb':1,'modestbranding':1,'rel':0,'showinfo':0}, events: {'onReady': onHiddenReady,'onStateChange': onPlayerStateChange,'onError': (e) => console.warn("hiddenPlayer error", e)}}); } catch (e) { console.error("YT create error:", e); } };
    function onVisibleReady() { checkPlayersReady(); }
    function onHiddenReady() { checkPlayersReady(); }
    function checkPlayersReady() { if (!state.visiblePlayer || !state.hiddenPlayer) return; state.playersReady = true; try { const iframeV = state.visiblePlayer.getIframe(); const iframeH = state.hiddenPlayer.getIframe(); if (iframeV) iframeV.setAttribute('allow', 'autoplay; encrypted-media; fullscreen'); if (iframeH) iframeH.setAttribute('allow', 'autoplay; encrypted-media; fullscreen'); } catch (e) {} resizePlayers(); if (state.pendingPlay) { const p = state.pendingPlay; state.pendingPlay = null; loadAndPlayById(p.videoId, p.autoplay); } if (state.queuedTrack) { const { video, queue, queueIndex } = state.queuedTrack; state.queuedTrack = null; playTrack(video, queue, queueIndex); } }
   
// === REEMPLAZA setupMediaSession POR ESTA VERSI√ìN ===
    function setupMediaSession() {
        if (!('mediaSession' in navigator) || !state.currentTrack) return;
        
        const player = getActivePlayer();
        if (!player) return;

        // 1. Metadatos (igual que antes)
        const snippet = state.currentTrack.snippet;
        navigator.mediaSession.metadata = new MediaMetadata({
            title: snippet.title,
            artist: snippet.channelTitle,
            artwork: [{ src: snippet.thumbnails?.high?.url || snippet.thumbnails?.default?.url, sizes: '512x512', type: 'image/jpeg' }]
        });

        // 2. Botones con "Intenci√≥n de Usuario"
        navigator.mediaSession.setActionHandler('play', () => { 
            state.userIntentionallyPaused = false; // El usuario quiere Play
            getActivePlayer()?.playVideo(); 
        });
        navigator.mediaSession.setActionHandler('pause', () => { 
            state.userIntentionallyPaused = true;  // El usuario quiere Pausa
            getActivePlayer()?.pauseVideo(); 
        });
        
        navigator.mediaSession.setActionHandler('previoustrack', () => playPrev());
        navigator.mediaSession.setActionHandler('nexttrack', () => playNext());
        
        navigator.mediaSession.setActionHandler('seekto', (details) => {
             if (details.seekTime && player.seekTo) player.seekTo(details.seekTime, true);
        });

        updateMediaSessionPosition();
    }

function updateMediaSessionPosition() {
        if (!('mediaSession' in navigator)) return;
        
        const player = getActivePlayer();
        if (!player || typeof player.getDuration !== 'function') return;

        try {
            const duration = player.getDuration();
            const currentTime = player.getCurrentTime();
            // Verificamos estado real
            const playerState = player.getPlayerState();
            const isPlaying = (playerState === YT.PlayerState.PLAYING);

            if (duration > 0 && isFinite(duration)) {
                navigator.mediaSession.setPositionState({
                    duration: duration,
                    // Si est√° sonando, playbackRate 1.0 hace que la barra se mueva sola.
                    // Si est√° pausado, 0.0 la deja quieta.
                    playbackRate: isPlaying ? 1.0 : 0.0,
                    position: Math.min(currentTime, duration)
                });
            }
        } catch(error) {
            console.warn("MediaSession sync error:", error);
        }
    }

// === REEMPLAZA onPlayerStateChange POR ESTA ===
    function onPlayerStateChange(event) {
        const active = getActivePlayer();
        if (event.target !== active) return;
        const s = event.data;
        
        if (s === YT.PlayerState.PLAYING) { 
            setPlayIcon(false); 
            state.isPlaying = true; 
            // Si est√° sonando, obviamente el usuario no quiere pausa
            state.userIntentionallyPaused = false; 
            
            showMiniPlayerAfterPlay(); 
            startProgressInterval();
            setupMediaSession(); 
            updateMediaSessionPosition();
        }
        else if (s === YT.PlayerState.PAUSED || s === YT.PlayerState.CUED) { 
            // === AQU√ç EST√Å LA MAGIA PARA SEGUNDO PLANO ===
            // Si el documento est√° oculto (minimizaste) Y NO fue tu intenci√≥n pausar...
            if (document.hidden && !state.userIntentionallyPaused) {
                // ¬°El celular intent√≥ detenerlo, pero nosotros lo forzamos a seguir!
                console.log("Sistema paus√≥ el audio, reanudando forzosamente...");
                active.playVideo();
                return; // Salimos para no cambiar √≠conos
            }
            
            setPlayIcon(true); 
            state.isPlaying = false; 
            stopProgressInterval(); 
            updateMediaSessionPosition();
        }
        else if (s === YT.PlayerState.ENDED) { 
            stopProgressInterval(); 
            if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "none";
            playNext(); 
        }
    }
    function getApiKey() { return CONFIG.API_KEYS[state.currentKeyIndex % CONFIG.API_KEYS.length]; }
    function rotateApiKey(){ state.currentKeyIndex = (state.currentKeyIndex + 1) % CONFIG.API_KEYS.length; console.warn('Rotando API key ->', state.currentKeyIndex); }
    function buildApiUrl(endpoint, params) { const BASE_URL = 'https://www.googleapis.com/youtube/v3'; const url = new URL(`${BASE_URL}${endpoint}`); for (const key in params) url.searchParams.set(key, params[key]); return url; }
    async function fetchWithRetry(url, retries = 3) { if (retries === 0) throw new Error("API retries exhausted."); url.searchParams.set('key', getApiKey()); try { const res = await fetch(url); if (!res.ok) { const errorData = await res.json().catch(()=>({error:{message:'unknown', code: res.status}})); const errorCode = errorData.error?.code; if (errorCode === 403 || errorCode === 400) { rotateApiKey(); url.searchParams.set('key', getApiKey()); return fetchWithRetry(url, retries - 1); } else { throw new Error(errorData.error?.message || res.statusText); } } return await res.json(); } catch (err) { console.error("fetch error:", err); return fetchWithRetry(url, retries - 1); } }
    
    function formatTime(seconds) { const min = Math.floor(seconds / 60); const sec = Math.floor(seconds % 60); return `${min}:${sec < 10 ? '0' : ''}${sec}`; }
function updateProgressBar() {
        // Validaci√≥n b√°sica
        if (state.isSeeking || !state.playersReady) return;
        
        const player = getActivePlayer();
        try {
            const currentTime = player.getCurrentTime(); 
            const duration = player.getDuration();
            
            // Solo actualizamos la interfaz WEB
            if (isFinite(currentTime) && isFinite(duration) && duration > 0) {
                dom.playerCurrentTime.textContent = formatTime(currentTime);
                dom.playerTotalDuration.textContent = formatTime(duration);
                dom.playerProgressBar.max = duration;
                dom.playerProgressBar.value = currentTime;
                
                const progressPercent = (currentTime / duration) * 100;
                dom.playerProgressBar.style.setProperty('--progress-percent', `${progressPercent}%`);
                
                // ¬°IMPORTANTE! AQU√ç NO LLAMAMOS A NADA M√ÅS.
                // El error anterior era llamar a updateMediaSessionPosition() aqu√≠.
                // B√ìRRALO si lo tienes.
            }
        } catch (e) {}
    }
    function startProgressInterval() { stopProgressInterval(); state.progressInterval = setInterval(updateProgressBar, 250); }
    function stopProgressInterval() { clearInterval(state.progressInterval); }

    function showLoading(container){ container.innerHTML = `<div class="flex justify-center items-center p-10"><div class="loader"></div></div>`; }
    function toggleHomeSections(show) { dom.homeCategoriesSection.classList.toggle('hidden', !show); dom.homePlaylistsSection.classList.toggle('hidden', !show); dom.homePopularSection.classList.toggle('hidden', !show); }
    function updatePlayingIndicator() { if (!state.currentTrack) return; const videoId = typeof state.currentTrack.id === 'object' ? state.currentTrack.id.videoId : state.currentTrack.id; document.querySelectorAll('.video-item-title').forEach(title => { title.classList.remove('text-blue-500', 'font-bold'); title.classList.add('font-medium'); }); const playingItems = document.querySelectorAll(`.video-item[data-video-id="${videoId}"]`); if (playingItems.length === 0) return; playingItems.forEach(item => { const title = item.querySelector('.video-item-title'); if (title) { title.classList.add('text-blue-500', 'font-bold'); title.classList.remove('font-medium'); } }); }
    function renderVideoList(container, items, listType = 'search', listId = null) { if (!items || items.length === 0) { container.innerHTML = '<p class="text-gray-400 text-center">No se encontraron resultados.</p>'; return; } container.innerHTML = items.map((item, index) => { const videoId = typeof item.id === 'object' ? item.id.videoId : item.id; const snippet = item.snippet; if (!snippet) return ''; const showDeleteBtn = (listType === 'recents') || (listType === 'library' && listId) || (listType === 'favorites'); const deleteIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" ></path></svg>`; return `<div class="flex items-center p-2 rounded-lg hover:bg-gray-800 video-item-wrapper"><div class="flex-1 flex items-center truncate cursor-pointer video-item" data-index="${index}" data-video-id="${videoId}"><img src="${snippet.thumbnails?.default?.url || 'https://placehold.co/120x90/000000/ffffff?text=?'}" alt="${snippet.title}" class="w-16 h-16 object-cover rounded-md mr-4"><div class="flex-1 truncate"><p class="font-medium truncate video-item-title">${snippet.title}</p><p class="text-sm text-gray-400 truncate">${snippet.channelTitle}</p></div></div>${showDeleteBtn ? `<button class="item-delete-btn ml-2" data-video-id="${videoId}" data-list-type="${listType}" data-list-id="${listId || ''}" title="Quitar de la lista">${deleteIcon}</button>` : ''}</div>`; }).join(''); container.querySelectorAll('.video-item').forEach(itemEl => { itemEl.addEventListener('click', () => { const index = parseInt(itemEl.dataset.index); playTrack(items[index], items, index); }); }); container.querySelectorAll('.item-delete-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); const videoId = btn.dataset.videoId; const type = btn.dataset.listType; const listId = btn.dataset.listId; if (type === 'recents') removeFromRecents(videoId); else if (type === 'library') removeFromLibrary(videoId, listId); else if (type === 'favorites') removeFromFavorites(videoId); }); }); updatePlayingIndicator(); }
    function renderFavorites() { if (state.favorites.length === 0) { dom.favoritesContainer.innerHTML = '<p class="text-gray-400 text-center">A√∫n no tienes favoritos. Presiona el ‚ô•Ô∏è en una canci√≥n para a√±adirla.</p>'; return; } renderVideoList(dom.favoritesContainer, state.favorites, 'favorites'); }
    function renderPlaylistList(container, playlists) { if (!playlists || playlists.length === 0) { container.innerHTML = '<p class="text-gray-400 text-center">No se encontraron playlists.</p>'; return; } container.innerHTML = playlists.map(pl => { const sn = pl.snippet || {}; const playlistId = (pl.id && pl.id.playlistId) ? pl.id.playlistId : (typeof pl.id === 'string' ? pl.id : (pl.playlistId || '')); return `<div class="bg-gray-800 p-3 rounded cursor-pointer playlist-item" data-playlist-id="${playlistId}" title="${sn.title}"><img src="${sn.thumbnails?.medium?.url || sn.thumbnails?.default?.url || 'https://placehold.co/320x180/000/fff?text=?'}" class="w-full h-36 object-cover rounded mb-2"><div class="text-sm font-medium truncate">${sn.title}</div><div class="text-xs text-gray-400 truncate">${sn.channelTitle}</div></div>`; }).join(''); container.querySelectorAll('.playlist-item').forEach(el => { el.addEventListener('click', async () => { const playlistId = el.dataset.playlistId; if (!playlistId) { dom.resultsContainer.innerHTML = `<p class="text-red-400">ID de playlist inv√°lido.</p>`; return; } await fetchPlaylistItemsAndRender(playlistId); }); }); }
    function showPage(pageId) { if(state.currentPage !== pageId) state.lastPage = state.currentPage; dom.pages.forEach(page => page.classList.toggle('active', page.id === `page-${pageId}`)); state.currentPage = pageId; const activePageEl = document.getElementById(`page-${pageId}`); if(activePageEl) activePageEl.scrollTop = 0; if (pageId === 'favorites') renderFavorites(); else if (pageId === 'home') { dom.homeTitle.textContent = 'Inicio'; dom.resultsContainer.innerHTML = ''; toggleHomeSections(true); } else if (pageId === 'recents') renderRecents(); else if (pageId === 'library') renderLibrariesPage(); }
    function toggleSidebar(show) { if (show) { dom.sidebarBackdrop.classList.remove('hidden'); dom.sidebar.classList.remove('-translate-x-full'); } else { dom.sidebarBackdrop.classList.add('hidden'); dom.sidebar.classList.add('-translate-x-full'); } }
    

// ==== INICIO DE CAMBIO (Paso 1) ====
    function updatePlayerUI(track) {
        if (!track || !track.snippet) {
            if (dom.playerBgImage) dom.playerBgImage.style.backgroundImage = 'none';
            dom.playerTitle.textContent = 'T√≠tulo de la Canci√≥n';
            dom.playerArtist.textContent = 'Nombre del Artista';
            dom.miniPlayerTitle.textContent = 'No hay nada sonando';
            dom.miniPlayerArtist.textContent = '...';
            dom.miniPlayerThumb.src = 'https://placehold.co/40x40/000000/FFFFFF?text=?';
            return;
        }
        
        const snippet = track.snippet; 
        const title = snippet.title;
        const artist = snippet.channelTitle;
        const thumb = snippet.thumbnails?.default?.url || 'https://placehold.co/40x40/000000/FFFFFF?text=?';
        
        // Imagen de alta calidad para el fondo y la pantalla de bloqueo
        const bgThumb = snippet.thumbnails?.maxres?.url || 
                        snippet.thumbnails?.high?.url || 
                        snippet.thumbnails?.medium?.url || 
                        thumb;
        
        if (dom.playerBgImage) {
            dom.playerBgImage.style.backgroundImage = `url('${bgThumb}')`;
        }

        // UI existente
        dom.playerTitle.textContent = title;
        dom.playerArtist.textContent = artist;
        dom.miniPlayerTitle.textContent = title;
        dom.miniPlayerArtist.textContent = artist;
        dom.miniPlayerThumb.src = thumb;
        updateFavoriteIcon();

        // --- C√ìDIGO NUEVO PARA SEGUNDO PLANO ---
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: title,
                artist: artist,
                album: 'Music Player',
                artwork: [
                    { src: thumb, sizes: '96x96', type: 'image/png' },
                    { src: bgThumb, sizes: '512x512', type: 'image/jpeg' }
                ]
            });
        }
    }
    // ==== FIN DE CAMBIO (Paso 1) ====

    function showFullPlayer() { dom.fullPlayer.classList.remove('translate-y-full'); dom.miniPlayer.classList.add('translate-y-full','opacity-0'); setTimeout(()=> resizePlayers(), 80); }
    function showMiniPlayerAfterPlay() { dom.miniPlayer.classList.remove('translate-y-full','opacity-0'); }
    function showMiniPlayer() { dom.fullPlayer.classList.add('translate-y-full'); dom.miniPlayer.classList.remove('translate-y-full','opacity-0'); hideQueuePanel(); }
function setPlayIcon(isPaused) {
  try {
    // UI del player completo (sin cambios)
    dom.playIcon.classList.toggle('hidden', !isPaused);
    dom.pauseIcon.classList.toggle('hidden', isPaused);

    // Si no existe el mini button, salimos
    if (!dom.miniPlayPauseBtn) return;

    // Limpiar clases previas y aplicar la correcta
    dom.miniPlayPauseBtn.classList.remove('mini-playing', 'mini-paused');
    if (isPaused) dom.miniPlayPauseBtn.classList.add('mini-paused');
    else dom.miniPlayPauseBtn.classList.add('mini-playing');

    // Fallback SVGs
    dom.miniPlayIcon?.classList.toggle('hidden', !isPaused);
    dom.miniPauseIcon?.classList.toggle('hidden', isPaused);

    // Asegurar ocultado/mostrado del ecualizador en el DOM para evitar estados est√°ticos:
    try {
      const eq = dom.miniPlayPauseBtn.querySelector('.mini-eq');
      if (eq) {
        if (isPaused) {
          // completamente oculto
          eq.style.display = 'none';
        } else {
          // restaurar (flex) antes de que la animaci√≥n se dispare por CSS
          eq.style.display = 'flex';
          // forzar reflow para que la animaci√≥n empiece bien
          void eq.offsetWidth;
        }
      }
    } catch (innerE) { /* no cr√≠tico */ }

    // Pulse anim (feedback visual)
    dom.miniPlayPauseBtn.classList.remove('pulse-anim');
    void dom.miniPlayPauseBtn.offsetWidth;
    dom.miniPlayPauseBtn.classList.add('pulse-anim');

  } catch (e) {
    console.warn('setPlayIcon error', e);
  }
}

    
    function updateFavoriteIcon() { if (!state.currentTrack) return; const videoId = typeof state.currentTrack.id === 'object' ? state.currentTrack.id.videoId : state.currentTrack.id; const isFav = state.favorites.some(fav => (typeof fav.id === 'object' ? fav.id.videoId : fav.id) === videoId); if (isFav) dom.favIconFull.classList.add('fill-red-500','text-red-500'); else dom.favIconFull.classList.remove('fill-red-500','text-red-500'); }
    function updateShuffleLoopIcons() { dom.shuffleBtn.classList.toggle('text-blue-500', state.isShuffle); dom.loopBtn.classList.toggle('text-blue-500', state.isLoop); }
    function resizePlayers() { try { if (state.visiblePlayer && state.visiblePlayer.getIframe) { const iframe = state.visiblePlayer.getIframe(); const w = dom.playerVideoContainer.clientWidth; const h = dom.playerVideoContainer.clientHeight; if (typeof state.visiblePlayer.setSize === 'function') state.visiblePlayer.setSize(w, h); if (iframe) { iframe.style.width = '100%'; iframe.style.height = '100%'; } } } catch(e){ console.warn('resizePlayers error', e); } }
    window.addEventListener('resize', () => { resizePlayers(); });
    
    function getActivePlayer() { return document.hidden ? (state.hiddenPlayer || state.visiblePlayer) : (state.visiblePlayer || state.hiddenPlayer); }
    function loadAndPlayById(videoId, autoplay = true) { if (!videoId || !state.playersReady) { state.pendingPlay = { videoId, autoplay }; return; } const target = getActivePlayer(); const other = (target === state.visiblePlayer) ? state.hiddenPlayer : state.visiblePlayer; try { try { if (other && other.stopVideo) other.stopVideo(); } catch(e){} if (typeof target.loadVideoById === 'function') { target.loadVideoById({ videoId, startSeconds: 0 }); if (autoplay) setTimeout(()=>{ try{ target.playVideo(); }catch(e){} }, 100); } else if (typeof target.cueVideoById === 'function') { target.cueVideoById({ videoId, startSeconds: 0 }); if (autoplay) setTimeout(()=>{ try{ target.playVideo(); }catch(e){} }, 100); } } catch (e) { console.error("Error loadAndPlayById:", e); } }
    function playTrack(video, queue = [], queueIndex = 0) { const videoId = typeof video.id === 'object' ? video.id.videoId : video.id; if (!videoId) { console.error("No videoId:", video); return; } if (!state.playersReady) { state.queuedTrack = { video, queue, queueIndex }; updatePlayerUI(video); showFullPlayer(); setPlayIcon(true); return; } state.currentTrack = video; state.currentQueue = queue; state.currentQueueIndex = queueIndex; state.queuedTrack = null; addToRecents(video); loadAndPlayById(videoId, true); updatePlayerUI(video); if (!document.hidden) showFullPlayer(); updatePlayingIndicator(); }
// === REEMPLAZA TU FUNCI√ìN togglePlayPause POR ESTA ===
    function togglePlayPause() {
        // Manejo de cola (sin cambios)
        if (!state.playersReady && state.queuedTrack) { 
            const { video, queue, queueIndex } = state.queuedTrack; 
            playTrack(video, queue, queueIndex); 
            return; 
        }

        const active = getActivePlayer();
        if (!active || !state.currentTrack) return;

        try {
            const st = (typeof active.getPlayerState === 'function') ? active.getPlayerState() : -1;
            
            if (st === YT.PlayerState.PLAYING) {
                // MARCAMOS QUE FUE EL USUARIO QUIEN PAUS√ì
                state.userIntentionallyPaused = true; 
                active.pauseVideo();
            } else {
                // MARCAMOS QUE EL USUARIO QUIERE REPRODUCIR
                state.userIntentionallyPaused = false;
                active.playVideo();
            }
        } catch(e) { 
            console.warn("togglePlayPause error", e); 
        }
    }
    
    function playNext() { if (!state.currentQueue.length) return; if (state.isLoop) { playTrack(state.currentTrack, state.currentQueue, state.currentQueueIndex); return; } let nextIndex = state.isShuffle ? Math.floor(Math.random() * state.currentQueue.length) : (state.currentQueueIndex + 1) % state.currentQueue.length; playTrack(state.currentQueue[nextIndex], state.currentQueue, nextIndex); }
    function playPrev() { if (!state.currentQueue.length) return; let prevIndex = state.isShuffle ? Math.floor(Math.random() * state.currentQueue.length) : (state.currentQueueIndex - 1 + state.currentQueue.length) % state.currentQueue.length; playTrack(state.currentQueue[prevIndex], state.currentQueue, prevIndex); }
    function toggleShuffle() { state.isShuffle = !state.isShuffle; updateShuffleLoopIcons(); }
    function toggleLoop() { state.isLoop = !state.isLoop; updateShuffleLoopIcons(); }

    function populateQueuePanel() { const queue = state.currentQueue; const container = dom.playerQueueList; if (!queue.length) { container.innerHTML = '<p class="text-gray-400 text-center p-4">No hay nada en la cola.</p>'; return; } container.innerHTML = queue.map((item, index) => { const snippet = item.snippet; if (!snippet) return ''; const isPlaying = (index === state.currentQueueIndex); const titleClass = isPlaying ? 'text-blue-500 font-bold' : 'font-medium'; return `<div class="flex items-center p-2 rounded-lg hover:bg-gray-700 cursor-pointer queue-item" data-index="${index}"><img src="${snippet.thumbnails?.default?.url || 'https://placehold.co/40x40/000/fff?text=?'}" alt="${snippet.title}" class="w-10 h-10 object-cover rounded-md mr-3"><div class="flex-1 truncate"><p class="${titleClass} truncate">${snippet.title}</p><p class="text-sm text-gray-400 truncate">${snippet.channelTitle}</p></div></div>`; }).join(''); container.querySelectorAll('.queue-item').forEach(itemEl => { itemEl.addEventListener('click', () => { const index = parseInt(itemEl.dataset.index); playTrack(state.currentQueue[index], state.currentQueue, index); }); }); }
    function showQueuePanel() { populateQueuePanel(); dom.playerQueuePanel.classList.add('visible'); }
    function hideQueuePanel() { dom.playerQueuePanel.classList.remove('visible'); }

    async function toggleFullScreen() {
        const container = dom.playerVideoContainer;
        try {
            if (!document.fullscreenElement) {
                if (container.requestFullscreen) await container.requestFullscreen();
                else if (container.webkitRequestFullscreen) await container.webkitRequestFullscreen();
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('landscape').catch(err => {
                        console.log("No se pudo bloquear la orientaci√≥n a horizontal:", err);
                    });
                }
            } else {
                if (document.exitFullscreen) await document.exitFullscreen();
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            }
        } catch(e) { 
            console.error("Error al cambiar a pantalla completa:", e); 
            showToast("La pantalla completa no es compatible."); 
        }
    }






    
    function loadFavorites() { const favs = localStorage.getItem(`${CONFIG.STORAGE_PREFIX}favorites`); if (favs) state.favorites = JSON.parse(favs); }
    function saveFavorites() { localStorage.setItem(`${CONFIG.STORAGE_PREFIX}favorites`, JSON.stringify(state.favorites)); }
    function toggleFavorite() { if (!state.currentTrack) return; const videoId = typeof state.currentTrack.id === 'object' ? state.currentTrack.id.videoId : state.currentTrack.id; const favIndex = state.favorites.findIndex(fav => (typeof fav.id === 'object' ? fav.id.videoId : fav.id) === videoId); if (favIndex > -1) { state.favorites.splice(favIndex,1); showToast('Eliminado de Favoritos'); } else { state.favorites.push(state.currentTrack); showToast('A√±adido a Favoritos'); } saveFavorites(); updateFavoriteIcon(); if (state.currentPage === 'favorites') renderFavorites(); }
    function removeFromFavorites(videoId) { const favIndex = state.favorites.findIndex(fav => (typeof fav.id === 'object' ? fav.id.videoId : fav.id) === videoId); if (favIndex > -1) { state.favorites.splice(favIndex, 1); saveFavorites(); renderFavorites(); showToast('Eliminado de Favoritos'); if (state.currentTrack) { const currentVideoId = typeof state.currentTrack.id === 'object' ? state.currentTrack.id.videoId : state.currentTrack.id; if (currentVideoId === videoId) updateFavoriteIcon(); } } }
    function loadLibraries() { const raw = localStorage.getItem(`${CONFIG.STORAGE_PREFIX}libraries`); if (raw) state.libraries = JSON.parse(raw); else state.libraries = []; }
    function saveLibraries() { localStorage.setItem(`${CONFIG.STORAGE_PREFIX}libraries`, JSON.stringify(state.libraries)); }
    function createLibrary(name) { if (!name || !name.trim()) return null; const id = `lib_${Date.now()}`; const lib = { id, name: name.trim(), items: [] }; state.libraries.push(lib); saveLibraries(); if(state.currentPage === 'library') renderLibrariesPage(); showToast(`Biblioteca "${lib.name}" creada`); return lib; }
    function deleteLibrary(libraryId) { state.libraries = state.libraries.filter(lib => lib.id !== libraryId); saveLibraries(); renderLibrariesPage(); showToast('Biblioteca eliminada'); }
    function removeFromLibrary(videoId, libraryId) { const lib = state.libraries.find(x => x.id === libraryId); if (!lib) return; lib.items = lib.items.filter(it => (typeof it.id === 'object' ? it.id.videoId : it.id) !== videoId); saveLibraries(); renderVideoList(dom.resultsContainer, lib.items, 'library', lib.id); showToast(`Eliminado de "${lib.name}"`); }
    function renderLibrariesPage() { const container = dom.libraryContainer; if (!container) return; if (!state.libraries.length) { container.innerHTML = `<p class="text-gray-400 text-center">No has creado ninguna biblioteca. Usa el men√∫ (‚ãØ) en una canci√≥n para crear una.</p>`; return; } container.innerHTML = state.libraries.map(lib => `<div class="bg-gray-800 p-4 rounded-lg mb-3 flex justify-between items-center library-item-wrapper"><div class="flex-1 flex items-center cursor-pointer library-item" data-library-id="${lib.id}"><div><h3 class="text-lg font-semibold">${lib.name}</h3><p class="text-sm text-gray-400">${lib.items.length} canciones</p></div><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 ml-auto mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" ></path></svg></div><button class="item-delete-btn" data-library-id="${lib.id}" title="Eliminar biblioteca"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" ></path></svg></button></div>`).join(''); container.querySelectorAll('.library-item').forEach(el => el.addEventListener('click', () => { const libId = el.dataset.libraryId; const lib = state.libraries.find(x => x.id === libId); if (!lib) return; showPage('home'); toggleHomeSections(false); dom.homeTitle.textContent = `Biblioteca: ${lib.name}`; if (!lib.items.length) { dom.resultsContainer.innerHTML = `<p class="text-gray-400 text-center">Biblioteca "${lib.name}" vac√≠a.</p>`; } else { renderVideoList(dom.resultsContainer, lib.items, 'library', lib.id); } })); container.querySelectorAll('.item-delete-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); const libId = btn.dataset.libraryId; const libName = state.libraries.find(l=>l.id===libId)?.name || 'esta biblioteca'; openConfirmModal(`¬øSeguro que quieres eliminar la biblioteca "${libName}"? Esta acci√≥n no se puede deshacer.`, () => deleteLibrary(libId)); })); }
    function addCurrentTrackToLibrary(libraryId) { if (!state.currentTrack) { showToast('No hay canci√≥n seleccionada.'); return; } const lib = state.libraries.find(x => x.id === libraryId); if (!lib) { showToast('Biblioteca no encontrada.'); return; } const videoId = typeof state.currentTrack.id === 'object' ? state.currentTrack.id.videoId : state.currentTrack.id; const exists = lib.items.some(it => (typeof it.id === 'object' ? it.id.videoId : it.id) === videoId); if (exists) { showToast('La canci√≥n ya est√° en la biblioteca.'); return; } lib.items.push(state.currentTrack); saveLibraries(); if(state.currentPage === 'library') renderLibrariesPage(); showToast(`A√±adido a "${lib.name}"`); }
    function loadRecents() { const raw = localStorage.getItem(`${CONFIG.STORAGE_PREFIX}recents`); if (raw) state.recents = JSON.parse(raw); else state.recents = []; }
    function saveRecents() { localStorage.setItem(`${CONFIG.STORAGE_PREFIX}recents`, JSON.stringify(state.recents)); }
    function addToRecents(video) { try { const id = typeof video.id === 'object' ? video.id.videoId : video.id; if (!id) return; state.recents = state.recents.filter(it => ((typeof it.id === 'object' ? it.id.videoId : it.id) !== id)); state.recents.unshift(video); if (state.recents.length > 50) state.recents.length = 50; saveRecents(); } catch(e){ console.warn('addToRecents error', e); } }
    function removeFromRecents(videoId) { state.recents = state.recents.filter(it => (typeof it.id === 'object' ? it.id.videoId : it.id) !== videoId); saveRecents(); renderRecents(); showToast('Eliminado de Recientes'); }
    function renderRecents() { if (!state.recents.length) { dom.recentsContainer.innerHTML = '<p class="text-gray-400 text-center">No has reproducido canciones todav√≠a.</p>'; return; } renderVideoList(dom.recentsContainer, state.recents, 'recents'); }
    async function fetchPopularMusic() { showLoading(dom.popularMusicContainer); try { const url = buildApiUrl('/videos', {part: 'snippet,contentDetails,statistics',chart: 'mostPopular',videoCategoryId: '10',regionCode: 'US',maxResults: CONFIG.YT_MAX_RESULTS}); const data = await fetchWithRetry(url); renderVideoList(dom.popularMusicContainer, data.items || []); } catch (error) { console.error("Error al cargar m√∫sica popular:", error); dom.popularMusicContainer.innerHTML = `<p class="text-red-400">Error al cargar la m√∫sica popular.</p>`; } }
    async function fetchVideosByQuery(query) { toggleHomeSections(false); showLoading(dom.resultsContainer); dom.homeTitle.textContent = `Resultados para: "${query}"`; try { const url = buildApiUrl('/search', {part: 'snippet',q: query,type: 'video',videoCategoryId: '10',maxResults: CONFIG.YT_MAX_RESULTS}); const data = await fetchWithRetry(url); renderVideoList(dom.resultsContainer, data.items || []); } catch (error) { console.error("Error al buscar videos:", error); dom.resultsContainer.innerHTML = `<p class="text-red-400">Error al buscar videos.</p>`; } }
    async function fetchPlaylistsByQuery(query) { showLoading(dom.playlistsContainer); try { const url = buildApiUrl('/search', {part: 'snippet',q: query,type: 'playlist',maxResults: 12}); const data = await fetchWithRetry(url); renderPlaylistList(dom.playlistsContainer, data.items || []); } catch (err) { console.error('Error playlists:', err); dom.playlistsContainer.innerHTML = `<p class="text-red-400">Error al cargar playlists.</p>`; } }
    async function fetchPlaylistItemsAndRender(playlistId) { showLoading(dom.playlistSongsContainer); showPage('playlist-details'); try { const url = buildApiUrl('/playlistItems', { part: 'snippet,contentDetails', playlistId, maxResults: CONFIG.YT_MAX_RESULTS }); const data = await fetchWithRetry(url); const items = (data.items || []).map(it => ({ id: { videoId: it.contentDetails.videoId }, snippet: it.snippet })); if (data.items.length > 0) { const firstItem = data.items[0].snippet; const coverArt = firstItem.thumbnails?.maxres?.url || firstItem.thumbnails?.high?.url || 'https://placehold.co/640x480/0f1724/ffffff?text=Playlist'; dom.playlistHeader.style.backgroundImage = `url('${coverArt}')`; dom.playlistTitle.textContent = firstItem.playlistTitle || "Playlist"; dom.playlistStickyTitle.textContent = firstItem.playlistTitle || "Playlist"; dom.playlistChannel.textContent = `Por: ${firstItem.videoOwnerChannelTitle || 'Desconocido'}`; renderVideoList(dom.playlistSongsContainer, items); } else { dom.playlistTitle.textContent = "Playlist Vac√≠a"; dom.playlistStickyTitle.textContent = "Playlist Vac√≠a"; dom.playlistSongsContainer.innerHTML = `<p class="text-gray-400 text-center">Esta playlist no contiene videos.</p>`; } } catch (err) { console.error('Error playlist items:', err); dom.playlistTitle.textContent = 'Error'; dom.playlistStickyTitle.textContent = 'Error'; dom.playlistSongsContainer.innerHTML = `<p class="text-red-400">Error al cargar los videos de la playlist.</p>`; } }
    function openConfirmModal(message, onConfirm) { const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop'; backdrop.id = 'confirm-modal-backdrop'; const modal = document.createElement('div'); modal.className = 'modal'; modal.innerHTML = `<h3 class="text-lg font-semibold">Confirmar Acci√≥n</h3><p class="text-gray-300 my-4">${message}</p><div class="flex gap-2 mt-4 justify-end"><button id="modal-confirm-yes" class="px-3 py-1 bg-red-600 rounded">S√≠, eliminar</button><button id="modal-confirm-no" class="px-3 py-1 bg-gray-600 rounded">Cancelar</button></div>`; backdrop.appendChild(modal); document.body.appendChild(backdrop); const close = () => { if (backdrop.parentNode) document.body.removeChild(backdrop); }; modal.querySelector('#modal-confirm-no').addEventListener('click', close); backdrop.addEventListener('click', (e) => { if(e.target === backdrop) close(); }); modal.querySelector('#modal-confirm-yes').addEventListener('click', () => { onConfirm(); close(); }); }
    function openLibraryOptionsModal() { if (!state.currentTrack) { showToast('No hay canci√≥n seleccionada.'); return; } const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop'; backdrop.id = 'library-options-backdrop'; const modal = document.createElement('div'); modal.className = 'modal'; modal.innerHTML = `<h3>Opciones de Biblioteca</h3><div id="modal-content"><p class="text-xs text-gray-400 mb-2">A√±ade esta canci√≥n a una biblioteca existente o crea una nueva.</p></div><div id="library-list-modal" class="max-h-40 overflow-y-auto my-3"></div><div id="create-library-form" class="hidden mt-3"><label class="text-xs text-gray-400">Nombre de la nueva biblioteca</label><input id="modal-create-library-input" class="w-full bg-gray-700 rounded p-2 mt-2" placeholder="Ej: Mix de Rock" /><div class="flex gap-2 mt-2 justify-end"><button id="modal-create-confirm" class="px-3 py-1 bg-blue-600 rounded">Crear y A√±adir</button><button id="modal-create-cancel-form" class="px-3 py-1 bg-gray-600 rounded">Cancelar</button></div></div><div id="modal-main-actions" class="flex gap-2 mt-4 justify-end"><button id="modal-add-to-lib-btn" class="px-3 py-1 bg-blue-600 rounded">A√±adir</button><button id="modal-new-lib-btn" class="px-3 py-1 bg-green-600 rounded">Crear Nueva</button><button id="modal-cancel-btn" class="px-3 py-1 bg-gray-600 rounded">Cerrar</button></div>`; backdrop.appendChild(modal); document.body.appendChild(backdrop); const content = modal.querySelector('#library-list-modal'), createForm = modal.querySelector('#create-library-form'), mainActions = modal.querySelector('#modal-main-actions'), addBtn = modal.querySelector('#modal-add-to-lib-btn'); if (!state.libraries.length) { content.innerHTML = `<p class="text-sm text-gray-300">No hay bibliotecas locales. Debes crear una.</p>`; addBtn.classList.add('hidden'); } else { const select = document.createElement('select'); select.className = 'w-full bg-gray-700 text-white rounded p-2'; select.id = 'modal-library-select'; select.innerHTML = state.libraries.map(lib => `<option value="${lib.id}">${lib.name} (${lib.items.length})</option>`).join(''); content.appendChild(select); } const close = () => { if (backdrop.parentNode) document.body.removeChild(backdrop); }; modal.querySelector('#modal-cancel-btn').addEventListener('click', close); backdrop.addEventListener('click', (e) => { if (e.target === backdrop) close(); }); modal.querySelector('#modal-new-lib-btn').addEventListener('click', () => { createForm.classList.remove('hidden'); mainActions.classList.add('hidden'); content.classList.add('hidden'); }); modal.querySelector('#modal-create-cancel-form').addEventListener('click', () => { createForm.classList.add('hidden'); mainActions.classList.remove('hidden'); content.classList.remove('hidden'); }); modal.querySelector('#modal-create-confirm').addEventListener('click', () => { const input = modal.querySelector('#modal-create-library-input'), name = input.value.trim(); if (name) { const newLib = createLibrary(name); if (newLib) addCurrentTrackToLibrary(newLib.id); close(); } else { showToast('Ingresa un nombre v√°lido.'); } }); modal.querySelector('#modal-add-to-lib-btn').addEventListener('click', () => { if (!state.libraries.length) return; const selectEl = document.getElementById('modal-library-select'); if (!selectEl) return; addCurrentTrackToLibrary(selectEl.value); close(); }); }
    function showToast(text, ms = 2500) { try { const t = document.createElement('div'); t.className = 'toast'; t.textContent = text; dom.toastRoot.appendChild(t); setTimeout(()=> { t.style.transition = 'opacity 300ms'; t.style.opacity = '0'; setTimeout(()=> { if (t.parentNode) t.parentNode.removeChild(t); }, 320); }, ms); } catch(e){ console.warn('toast error', e); } }



 function initApp() {
        if (!auth || !auth.currentUser) return;

        // Event listeners principales
        dom.openSidebarBtn.addEventListener('click', () => toggleSidebar(true)); 
        dom.closeSidebarBtn.addEventListener('click', () => toggleSidebar(false)); 
        dom.sidebarBackdrop.addEventListener('click', () => toggleSidebar(false));
        
        dom.navLinks.forEach(link => { 
            link.addEventListener('click', (e) => { 
                e.preventDefault(); 
                showPage(e.currentTarget.dataset.page); 
                toggleSidebar(false); 
            }); 
        });

        dom.searchButton.addEventListener('click', () => { 
            const query = dom.searchInput.value.trim(); 
            if (query) { fetchVideosByQuery(query); showPage('home'); } 
        });
        
        dom.searchInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') dom.searchButton.click(); 
        });
        
        dom.searchPlaylistsButton.addEventListener('click', () => { 
            const query = dom.searchInput.value.trim() || 'Top playlists'; 
            fetchPlaylistsByQuery(query); 
            showPage('home'); 
        });
        
        dom.categoryButtons.forEach(button => { 
            button.addEventListener('click', () => { 
                fetchVideosByQuery(button.dataset.category + " music"); 
                showPage('home'); 
            }); 
        });

        dom.minimizePlayerBtn.addEventListener('click', ()=>showMiniPlayer());
        dom.maximizePlayerBtn.addEventListener('click', ()=>showFullPlayer());
        
        dom.playPauseBtn.addEventListener('click', togglePlayPause);
        dom.miniPlayPauseBtn.addEventListener('click', togglePlayPause);
        
        dom.nextBtn.addEventListener('click', playNext); 
        dom.prevBtn.addEventListener('click', playPrev);
        
        dom.shuffleBtn.addEventListener('click', toggleShuffle); 
        dom.loopBtn.addEventListener('click', toggleLoop);
        
        dom.favBtnFull.addEventListener('click', toggleFavorite);
        dom.libraryOptionsBtn.addEventListener('click', () => openLibraryOptionsModal());

        // Listeners de playlist y barra de progreso
        dom.playlistBackBtn.addEventListener('click', () => { showPage(state.lastPage || 'home'); });
        dom.playlistPage.addEventListener('scroll', () => { dom.playlistPage.classList.toggle('scrolled', dom.playlistPage.scrollTop > 150); });
        
        dom.playerProgressBar.addEventListener('input', (e) => { 
            const newTime = e.target.value; 
            dom.playerCurrentTime.textContent = formatTime(newTime); 
            dom.playerProgressBar.style.setProperty('--progress-percent', `${(newTime / dom.playerProgressBar.max) * 100}%`); 
        });
// Busca esto dentro de initApp():
        dom.playerProgressBar.addEventListener('change', (e) => { 
            const newTime = e.target.value;
            getActivePlayer().seekTo(newTime, true); 
            state.isSeeking = false; 
            
            // AGREGA ESTA L√çNEA:
            // Al soltar la barra, avisamos a Android de la nueva posici√≥n
            setTimeout(() => updateMediaSessionPosition(), 100); 
        });
        dom.playerProgressBar.addEventListener('mousedown', () => { state.isSeeking = true; });
        dom.playerProgressBar.addEventListener('mouseup', () => { state.isSeeking = false; });
        
        // Gestos del panel de cola
        dom.queueTriggerArea.addEventListener('touchstart', e => { state.touchStartY = e.touches[0].clientY; state.touchMoveY = e.touches[0].clientY; }, { passive: true });
        dom.queueTriggerArea.addEventListener('touchmove', e => { state.touchMoveY = e.touches[0].clientY; }, { passive: true });
        dom.queueTriggerArea.addEventListener('touchend', () => { if (state.touchStartY - state.touchMoveY > 50) { showQueuePanel(); } state.touchStartY = 0; state.touchMoveY = 0; });

        dom.playerQueueHandle.addEventListener('touchstart', e => { state.touchStartY = e.touches[0].clientY; state.touchMoveY = e.touches[0].clientY; }, { passive: true });
        dom.playerQueueHandle.addEventListener('touchmove', e => { state.touchMoveY = e.touches[0].clientY; }, { passive: true });
        dom.playerQueueHandle.addEventListener('touchend', () => { if (state.touchMoveY > 0 && state.touchMoveY - state.touchStartY > 50) { hideQueuePanel(); } state.touchStartY = 0; state.touchMoveY = 0; });
        
        dom.fullscreenBtn.addEventListener('click', toggleFullScreen);

        // === CORRECCI√ìN VISUAL SEGUNDO PLANO ===
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                // Si ocultas la app, paramos la actualizaci√≥n visual (ahorra bater√≠a y evita desync)
                stopProgressInterval();
            } else {
                // Al volver, actualizamos la barra inmediatamente y reanudamos
                updateProgressBar();
                if (state.isPlaying) startProgressInterval();
            }
        });

        loadFavorites(); loadLibraries(); loadRecents();
        fetchPopularMusic(); fetchPlaylistsByQuery('Top music');
    }

// ---- Nuevo onAuthStateChanged: valida userMeta y muestra notificaci√≥n con contacto ----
onAuthStateChanged(auth, async (user) => {
  authVerifying = false;

  // Si no hay usuario, mostramos overlay con el formulario (como antes)
  if (!user) {
    try { stopProgressInterval(); } catch(e){}
    showAuthOverlay(true, ''); // formulario normal sin mensaje
    // limpiar suscripciones previas
    if (window._userMetaUnsub) { try { window._userMetaUnsub(); } catch(e){} window._userMetaUnsub = null; }
    return;
  }

  // Si hay usuario, mantenemos la verificaci√≥n del device lock
  authVerifying = true;
  try {
    const allowed = await checkAndBindDevice(user);
    authVerifying = false;

    if (!allowed) {
      showAuthOverlay(true, `<strong>Acceso denegado:</strong> esta cuenta ya est√° registrada en otro dispositivo.`);
      return;
    }

    // Validamos userMeta en RTDB
    try {
      const db = getDatabase(firebaseApp);
      const metaRef = ref(db, `userMeta/${user.uid}`);

      // lectura inicial one-time
      const snap = await get(metaRef);
      const meta = snap && snap.exists() ? snap.val() : null;

      // funci√≥n local para mostrar mensaje con contacto
      const showExpiredNotification = (reason) => {
        // Construimos mensaje HTML con contacto del proveedor
        const contactEmail = PROVIDER_CONTACT?.email || '';
        const contactPhone = PROVIDER_CONTACT?.phone || '';
        let contactHtml = '';
        if (contactEmail) contactHtml += `<div style="margin-top:8px"><a href="mailto:${contactEmail}" style="color:#ffd166;font-weight:700">Contactar por email</a></div>`;
        if (contactPhone) contactHtml += `<div style="margin-top:6px;color:#cbd5e1">Tel√©fono: <strong>${contactPhone}</strong></div>`;
        const html = `<div>
                        <div style="font-size:15px;color:#ff8a8a;font-weight:700">${reason}</div>
                        <div style="margin-top:8px;color:#cbd5e1">Tu acceso ha sido restringido. Para reactivar, comun√≠cate con el proveedor:</div>
                        ${contactHtml}
                      </div>`;
        showAuthOverlay(true, html, false);
      };

      // Chequeo inicial
      const now = Date.now();
      if (meta && (meta.disabled || (meta.expiresAt && Number(meta.expiresAt) <= now))) {
        // Mostrar notificaci√≥n con contacto y forzar sign out
        const reason = meta.disabled ? 'Cuenta deshabilitada' : 'Suscripci√≥n expirada';
        showExpiredNotification(reason);
        try { await firebaseSignOut(auth); } catch(e){ console.warn('signOut after disabled error', e); }
        return;
      }

      // Si est√° todo OK, ocultamos overlay y arrancamos la app si a√∫n no est√°
      resetAuthLock();
      showAuthOverlay(false);
      if (!appInitialized) { initApp(); appInitialized = true; }

      // Suscribirnos a cambios en userMeta para notificar en tiempo real si el admin la desactiva o expira
      // guardamos la suscripci√≥n para limpiar si hace logout
      // onValue devuelve el callback; para modular SDK usaremos la referencia y onValue con callback
      const unsubscribeCallback = onValue(metaRef, (s) => {
        const m = s && s.val ? s.val() : null;
        if (!m) return;
        const now2 = Date.now();
        if (m.disabled || (m.expiresAt && Number(m.expiresAt) <= now2)) {
          const reason2 = m.disabled ? 'Cuenta deshabilitada' : 'Suscripci√≥n expirada';
          // Mostrar notificaci√≥n con contacto
          const contactEmail = PROVIDER_CONTACT?.email || '';
          const contactPhone = PROVIDER_CONTACT?.phone || '';
          let contactHtml = '';
          if (contactEmail) contactHtml += `<div style="margin-top:8px"><a href="mailto:${contactEmail}" style="color:#ffd166;font-weight:700">Contactar por email</a></div>`;
          if (contactPhone) contactHtml += `<div style="margin-top:6px;color:#cbd5e1">Tel√©fono: <strong>${contactPhone}</strong></div>`;
          const html2 = `<div>
                           <div style="font-size:15px;color:#ff8a8a;font-weight:700">${reason2}</div>
                           <div style="margin-top:8px;color:#cbd5e1">Tu acceso ha sido restringido. Para reactivar, comun√≠cate con el proveedor:</div>
                           ${contactHtml}
                         </div>`;
          showAuthOverlay(true, html2, false);
          // Forzar cierre de sesi√≥n
          try { firebaseSignOut(auth); } catch(e){ console.warn('signOut forced after onValue', e); }
        }
      }, (err) => {
        console.warn('userMeta onValue error', err);
      });

      // Guardamos la referencia para poder limpiar si lo necesitas
      window._userMetaRef = metaRef;
      window._userMetaUnsub = () => {
        try {
          // en modular SDK no hay off() en la misma forma; esta es una forma sencilla de quitar listener
          // Nota: para robustez en proyectos grandes deber√≠as usar la API apropiada de onValue/off en modular SDK
          if (window._userMetaRef && window._userMetaRef._path) {
            // intento best-effort de limpiar (si utilizas v9 modular, onValue retorna funci√≥n que no se expone aqu√≠,
            // por simplicidad dejamos esta referencia; al hacer signOut onAuthStateChanged limpia el UI)
          }
        } catch(e){}
      };

    } catch (errMeta) {
      console.error('Error al leer userMeta:', errMeta);
      try { await firebaseSignOut(auth); } catch(e){}
      showAuthOverlay(true, `<strong>Error al verificar metadatos.</strong> Intenta m√°s tarde.`);
      return;
    }

  } catch (e) {
    console.error('Error en onAuthStateChanged verification flow', e);
    authVerifying = false;
    try { await firebaseSignOut(auth); } catch (err) { console.warn('signOut error after verification failure', err); }
    showAuthOverlay(true, 'Error al verificar dispositivo. Intenta m√°s tarde.', false);
  }
});


    </script>
</body>
</html>
